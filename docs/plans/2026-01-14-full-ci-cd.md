# Full CI/CD Plan (Vercel + MCP + npm)

## Requirement Analysis

### Goal
- Provide end-to-end CI/CD coverage for CLI, dashboard, and Insforge functions.

### Scope
- In scope:
  - CI on PR + main for tests, guardrails, and build checks across modules.
  - CD on main for CLI npm publish (auto) and dashboard deploy (Vercel Git integration).
  - CD gate for Insforge functions: manual MCP deployment with explicit confirmation.
  - Preflight checks for required database tables before release.
  - Release evidence in docs/deployment/freeze.md.
- Out of scope:
  - Automatic Insforge function deployment from CI.
  - Infrastructure provisioning for Vercel/Insforge/npm.
  - Multi-environment (staging) pipelines.

### Users / Actors
- Developers and release maintainers.
- GitHub Actions.
- Vercel (Git integration).
- npm registry.
- Insforge MCP operator.

### Inputs
- Pull requests and merges to main.
- GitHub Secrets (NPM_TOKEN, INSFORGE_*).
- Version in package.json.
- Vercel deployment status checks.

### Outputs
- CI status checks for PRs and main.
- npm package publish for CLI.
- Vercel production deployment.
- Manual MCP deploy confirmation for functions.
- Release record in docs/deployment/freeze.md.

### Business Rules
- Insforge functions MUST be deployed only via MCP.
- npm publish MUST be skipped if version is already published.
- Release MUST fail if required tables are missing.
- Deploy evidence MUST be recorded in docs/deployment/freeze.md.

### Assumptions
- Vercel Git integration is already configured for the dashboard.
- GitHub repository has secrets for npm publish and Insforge preflight.
- MCP operator is available after main merges.

### Dependencies
- GitHub Actions.
- Vercel deployment checks.
- npm registry.
- Insforge2 MCP access.

### Risks
- Auto publish without version change (guard with npm view).
- Manual MCP step skipped (enforce explicit confirmation gate).
- Vercel deploy fails silently (require status check as merge gate).

## Acceptance Criteria

## Feature: Full CI/CD

### Requirement: CI runs for all modules on PR + main
- Rationale: Prevent regressions before release.

#### Scenario: CI on PR
- WHEN a pull request is opened or updated
- THEN CI SHALL run tests, guardrails, and build checks for CLI, dashboard, and Insforge functions
- AND failure SHALL block merge

### Requirement: CLI is published automatically on main
- Rationale: Keep npm package aligned with main.

#### Scenario: Publish when version is new
- WHEN main is updated with a version not yet published to npm
- THEN the pipeline SHALL publish the package to npm
- AND the workflow SHALL report success in GitHub checks

#### Scenario: Skip when version already exists
- WHEN main is updated but the package version already exists in npm
- THEN the pipeline SHALL skip publishing and report a no-op

### Requirement: Dashboard deploys via Vercel Git integration
- Rationale: Keep dashboard in sync with main without manual steps.

#### Scenario: Vercel deployment check
- WHEN main is updated
- THEN Vercel SHALL deploy the dashboard
- AND a Vercel status check SHALL appear on the commit

### Requirement: Insforge functions require manual MCP deploy gate
- Rationale: Functions can only be deployed via MCP.

#### Scenario: Functions changed on main
- WHEN changes touch insforge-src/functions or insforge-functions
- THEN the release workflow SHALL require manual confirmation that MCP deploy completed
- AND release completion SHALL be blocked until confirmation is provided

### Requirement: Preflight table checks run before release
- Rationale: Prevent missing schema failures.

#### Scenario: Preflight passes
- WHEN the release workflow runs
- THEN scripts/acceptance/model-identity-alias-table.cjs SHALL pass
- AND failure SHALL block release completion

### Requirement: Release evidence is recorded
- Rationale: Make deployments reviewable and reproducible.

#### Scenario: Freeze record entry
- WHEN a release completes
- THEN docs/deployment/freeze.md SHALL be updated with scope, commands, and verification

## Test Strategy

### Objectives
- Ensure CI/CD gates run as designed across CLI, dashboard, and functions.

### Test Levels
- Unit: Not applicable (workflow logic).
- Integration: GitHub Actions workflow runs for CI and release.
- Regression: npm test, guardrails, dashboard build, insforge build check.
- Performance: Not applicable.

### Test Matrix
- CI runs on PR + main -> Integration -> Repo maintainers -> GitHub Actions status
- npm publish gate -> Integration -> Repo maintainers -> Workflow logs
- Vercel deploy gate -> Integration -> Repo maintainers -> Vercel status check
- MCP manual gate -> Integration -> Repo maintainers -> Workflow manual approval record
- Preflight check -> Integration -> Repo maintainers -> Workflow logs

### Environments
- GitHub Actions (ubuntu-latest).
- Vercel production environment.

### Automation Plan
- GitHub Actions workflows for CI and release.
- npm publish handled by CI with NPM_TOKEN.

### Entry / Exit Criteria
- Entry: Secrets configured, Vercel integration active.
- Exit: CI/CD workflows pass and release evidence recorded.

### Coverage Risks
- Manual MCP step cannot be enforced programmatically beyond confirmation.

## Milestones

### M1 - Requirements & Acceptance
- Entry criteria: Scope confirmed (CLI + dashboard + functions).
- Exit criteria: Requirements + acceptance criteria drafted.
- Required artifacts: This document.

### M2 - OpenSpec Proposal
- Entry criteria: M1 complete.
- Exit criteria: Proposal, tasks, and spec delta created and validated.
- Required artifacts: openspec/changes/2026-01-14-add-full-ci-cd/...

### M3 - CI Implementation
- Entry criteria: Proposal approved.
- Exit criteria: CI workflows cover tests + build checks for all modules.
- Required artifacts: GitHub Actions workflow(s) + logs.

### M4 - CD Implementation
- Entry criteria: M3 complete.
- Exit criteria: npm publish automation + Vercel status gate + MCP manual gate.
- Required artifacts: Release workflow + documented manual MCP step.

### M5 - Release & Monitoring
- Entry criteria: CD pipeline complete.
- Exit criteria: Release evidence recorded in docs/deployment/freeze.md.
- Required artifacts: Freeze record entry + workflow logs.
