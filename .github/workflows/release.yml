name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.changes.outputs.functions }}
      dashboard: ${{ steps.changes.outputs.dashboard }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect changed areas
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="${AFTER}^"
          fi
          git diff --name-only "$BEFORE" "$AFTER" > /tmp/changed.txt
          if grep -E -q '^(insforge-src/functions/|insforge-functions/)' /tmp/changed.txt; then
            echo "functions=true" >> "$GITHUB_OUTPUT"
          else
            echo "functions=false" >> "$GITHUB_OUTPUT"
          fi
          if grep -E -q '^dashboard/' /tmp/changed.txt; then
            echo "dashboard=true" >> "$GITHUB_OUTPUT"
          else
            echo "dashboard=false" >> "$GITHUB_OUTPUT"
          fi

  preflight:
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Verify model alias table exists
        env:
          INSFORGE_BASE_URL: ${{ secrets.INSFORGE_BASE_URL }}
          INSFORGE_ANON_KEY: ${{ secrets.INSFORGE_ANON_KEY }}
          INSFORGE_SERVICE_ROLE_KEY: ${{ secrets.INSFORGE_SERVICE_ROLE_KEY }}
          INSFORGE_API_KEY: ${{ secrets.INSFORGE_API_KEY }}
        run: node scripts/acceptance/model-identity-alias-table.cjs

  npm-publish:
    runs-on: ubuntu-latest
    needs: [changes, preflight, vercel-gate, mcp-confirmation, mcp-skip]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' &&
      needs.preflight.result == 'success' &&
      needs.vercel-gate.result == 'success' &&
      (
        (needs.changes.outputs.functions == 'true' && needs.mcp-confirmation.result == 'success') ||
        (needs.changes.outputs.functions == 'false' && needs.mcp-skip.result == 'success')
      )
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Read package metadata
        id: package
        run: |
          node -e "const pkg=require('./package.json'); console.log('name='+pkg.name); console.log('version='+pkg.version);" >> "$GITHUB_OUTPUT"
      - name: Check npm registry for version
        id: npm
        run: |
          set -euo pipefail
          NAME="${{ steps.package.outputs.name }}"
          VERSION="${{ steps.package.outputs.version }}"
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish to npm
        if: steps.npm.outputs.exists != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish
      - name: Skip publish (version exists)
        if: steps.npm.outputs.exists == 'true'
        run: echo "Version already published; skipping."

  vercel-gate:
    runs-on: ubuntu-latest
    needs: [changes, preflight]
    timeout-minutes: 25
    permissions:
      checks: read
      contents: read
    env:
      VERCEL_CHECK_NAME: ${{ vars.VERCEL_CHECK_NAME || 'Vercel' }}
      VERCEL_TIMEOUT_MINUTES: "20"
      VERCEL_POLL_SECONDS: "20"
    steps:
      - name: Skip Vercel gate (no dashboard changes)
        if: needs.changes.outputs.dashboard != 'true'
        run: echo "No dashboard changes detected; Vercel gate satisfied."
      - name: Wait for Vercel deployment check
        if: needs.changes.outputs.dashboard == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const targetName = process.env.VERCEL_CHECK_NAME;
            const timeoutMinutes = Number(process.env.VERCEL_TIMEOUT_MINUTES || 20);
            const pollSeconds = Number(process.env.VERCEL_POLL_SECONDS || 20);
            const deadline = Date.now() + timeoutMinutes * 60 * 1000;
            const { owner, repo } = context.repo;
            const ref = context.sha;

            function pickLatest(statuses) {
              return statuses.sort((a, b) => {
                const aTime = new Date(a.created_at || 0).getTime();
                const bTime = new Date(b.created_at || 0).getTime();
                return bTime - aTime;
              })[0];
            }

            while (Date.now() < deadline) {
              const response = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref });
              const statuses = response.data.statuses.filter((status) =>
                status.context === targetName
              );

              if (statuses.length === 0) {
                core.info(`Waiting for Vercel status "${targetName}"...`);
              } else {
                const latest = pickLatest(statuses);
                core.info(`Latest Vercel status: ${latest.context} (${latest.state})`);
                if (latest.state === 'success') {
                  core.info('Vercel status succeeded.');
                  return;
                }
                if (['failure', 'error'].includes(latest.state)) {
                  throw new Error(`Vercel status ${latest.context} concluded with ${latest.state}`);
                }
              }

              await new Promise((resolve) => setTimeout(resolve, pollSeconds * 1000));
            }

            throw new Error(`Timed out waiting for Vercel check containing "${targetName}".`);

  mcp-confirmation:
    runs-on: ubuntu-latest
    needs: [changes, preflight]
    if: needs.changes.outputs.functions == 'true'
    timeout-minutes: 240
    environment:
      name: insforge-mcp
    steps:
      - name: MCP deploy confirmation
        run: |
          echo "Functions changed. Deploy via Insforge MCP, then approve this environment to continue."

  mcp-skip:
    runs-on: ubuntu-latest
    needs: [changes, preflight]
    if: needs.changes.outputs.functions == 'false'
    steps:
      - name: Skip MCP gate (no function changes)
        run: echo "No function changes detected; MCP gate satisfied."
